{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Light Sensor Data</title>
    <link href="{% static "sensor_data/css/_styles.css" %}" rel="stylesheet"/>
</head>
<body>

<div id="container">
    <h1>Light Level</h1>
    <div class="bar-container">
        <div class="bar"></div>
    </div>
    <div class="bar-label">
        <span class="zero">0</span>
        <span class="thousand">1000</span>
    </div>
    <div class="current-level-container"></div>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-color/2.1.2/jquery.color.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script>

    function determineColor(data) {
        var alpha;
        if (data < 250) {
            alpha = '1';
        } else if (data < 500) {
            alpha = '0.9';
        } else if (data < 970) {
            alpha = '0.7';
        } else {
            alpha = '0.3';
        }
        return "rgba(72,165,226," + alpha + ")";
    }

    function determineExtraMessage(data) {
        var message;
        if (data < 125) {
            message = '- oh, so dark';
        } else if (data > 980){
            message = '- oof, it\'s like being on the sun';
        }
        return message;
    }

    var wsClient = new WebSocket("ws://light.dpmercado.com:8768");
    wsClient.onopen = function(){
        console.log('Connection open!');
    };

    wsClient.onmessage = function (message) {
        var
            maxLevels = 40,
            incomingData = parseInt(message.data, 10),
            extraMessage = determineExtraMessage(incomingData),
            color = determineColor(incomingData),
            width = ((incomingData / 1000) * 100) + "%",
            $currentLevels = $('.current-level-item'),
            $bar = $('.bar');

        $bar.animate({ width : width, backgroundColor: color });

        if (incomingData > 980) {
            $bar.addClass('rainbow-cake');
        } else {
            $bar.removeClass('rainbow-cake');
        }

        if (length === maxLevels) {
             $currentLevels.last().remove();
        }

        $('.current-level-container').prepend(
                "<div class=\"current-level-item\">"
                + incomingData
                + (extraMessage
                    ? "<span class='tiny-message'>" + extraMessage + "</span>"
                    : '')
                + "</div>");

    };

    wsClient.onerror = function (error) {
        console.log(error);
    }

</script>
</body>
</html>